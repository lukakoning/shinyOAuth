<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example: Spotify login to display listening data • shinyOAuth</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example: Spotify login to display listening data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shinyOAuth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/audit-logging.html">Audit logging and hooks</a></li>
    <li><a class="dropdown-item" href="../articles/authentication-flow.html">Authentication flow</a></li>
    <li><a class="dropdown-item" href="../articles/example-spotify.html">Example: Spotify login to display listening data</a></li>
    <li><a class="dropdown-item" href="../articles/usage.html">Usage</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lukakoning/shinyOAuth/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example: Spotify login to display listening data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lukakoning/shinyOAuth/blob/master/vignettes/example-spotify.Rmd" class="external-link"><code>vignettes/example-spotify.Rmd</code></a></small>
      <div class="d-none name"><code>example-spotify.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette demonstrates the code for an example Shiny application
that uses the <code>shinyOAuth</code> package to authenticate users via
Spotify’s OAuth 2.0 service.</p>
<p>After logging in, the app fetches and displays data about the user
and their listening behaviour in the form of a simple dashboard built
with ‘bslib’. It shows the user’s profile information with their avatar,
a live view of what they are currently playing, their top tracks and
artists, and a history of recently played songs.</p>
<p>For a more detailed explanation of how to use ‘shinyOAuth’ and its
features, see:
<code><a href="../articles/usage.html">vignette("usage", package = "shinyOAuth")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="code">Code<a class="anchor" aria-label="anchor" href="#code"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example Shiny app using shinyOAuth to connect to Spotify API</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># This app demonstrates logging into Spotify with shinyOAuth and fetching</span></span>
<span><span class="co"># various user statistics via the Spotify Web API. We then build a simple</span></span>
<span><span class="co"># dashboard to display this information</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Requirements:</span></span>
<span><span class="co"># - Create a Spotify OAuth 2.0 application at https://developer.spotify.com</span></span>
<span><span class="co"># - Add a redirect URI that matches redirect_uri below (default: http://127.0.0.1:8100)</span></span>
<span><span class="co"># - Set environment variables `SPOTIFY_OAUTH_CLIENT_ID` and `SPOTIFY_OAUTH_CLIENT_SECRET`</span></span>
<span></span>
<span><span class="co"># Load packages &amp; configure OAuth 2.0 client for Spotify -----------------------</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lukakoning/shinyOAuth" class="external-link">shinyOAuth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/bslib/" class="external-link">bslib</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Configure provider and client for Spotify</span></span>
<span></span>
<span><span class="va">provider</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_provider_spotify.html">oauth_provider_spotify</a></span><span class="op">(</span></span>
<span>  <span class="co"># For Spotify, scopes have to be given in the authentication request itself;</span></span>
<span>  <span class="co"># `oauth_provider_spotify()` handles this via the `scope` argument</span></span>
<span>  scope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"user-read-email"</span>,</span>
<span>      <span class="st">"user-read-private"</span>,</span>
<span>      <span class="st">"user-top-read"</span>,</span>
<span>      <span class="st">"user-read-recently-played"</span>,</span>
<span>      <span class="st">"user-read-playback-state"</span>,</span>
<span>      <span class="st">"user-read-currently-playing"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    collapse <span class="op">=</span> <span class="st">" "</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_client.html">oauth_client</a></span><span class="op">(</span></span>
<span>  provider <span class="op">=</span> <span class="va">provider</span>,</span>
<span>  client_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPOTIFY_OAUTH_CLIENT_ID"</span><span class="op">)</span>,</span>
<span>  client_secret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SPOTIFY_OAUTH_CLIENT_SECRET"</span><span class="op">)</span>,</span>
<span>  redirect_uri <span class="op">=</span> <span class="st">"http://127.0.0.1:8100"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Spotify API helpers ----------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># Small helpers to call Spotify API with the user's access token</span></span>
<span><span class="co"># We define a few specialized functions for common endpoints</span></span>
<span></span>
<span><span class="va">spotify_get</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span>, <span class="va">path</span>, <span class="va">query</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"https://api.spotify.com"</span>, <span class="va">path</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/client_bearer_req.html">client_bearer_req</a></span><span class="op">(</span><span class="va">token</span>, <span class="va">url</span>, query <span class="op">=</span> <span class="va">query</span><span class="op">)</span></span>
<span>  <span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu">req_with_retry</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_status.html" class="external-link">resp_is_error</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Spotify API error: HTTP %s"</span>, <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_status.html" class="external-link">resp_status</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="va">msg</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="va">resp</span>, simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Specialized helper for endpoints that may return 204 (e.g., currently-playing)</span></span>
<span><span class="va">spotify_get_maybe_empty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span>, <span class="va">path</span>, <span class="va">query</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"https://api.spotify.com"</span>, <span class="va">path</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/client_bearer_req.html">client_bearer_req</a></span><span class="op">(</span><span class="va">token</span>, <span class="va">url</span>, query <span class="op">=</span> <span class="va">query</span><span class="op">)</span></span>
<span>  <span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu">req_with_retry</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">status</span> <span class="op">&lt;-</span> <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_status.html" class="external-link">resp_status</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">204L</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_status.html" class="external-link">resp_is_error</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Spotify API error: HTTP %s"</span>, <span class="va">status</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="va">msg</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_json</a></span><span class="op">(</span><span class="va">resp</span>, simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fetch top tracks and artists (short_term: last 4 weeks)</span></span>
<span><span class="va">get_top_tracks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span>, <span class="va">limit</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">time_range</span> <span class="op">=</span> <span class="st">"short_term"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spotify_get</span><span class="op">(</span></span>
<span>    <span class="va">token</span>,</span>
<span>    <span class="st">"/v1/me/top/tracks"</span>,</span>
<span>    query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="va">limit</span>, time_range <span class="op">=</span> <span class="va">time_range</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">items</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">items</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">item</span> <span class="op">&lt;-</span> <span class="va">items</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      name <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_character_</span>,</span>
<span>      artist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">artists</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>      album <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">album</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_character_</span>,</span>
<span>      popularity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">popularity</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_real_</span>,</span>
<span>      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fetch top artists</span></span>
<span><span class="va">get_top_artists</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span>, <span class="va">limit</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">time_range</span> <span class="op">=</span> <span class="st">"short_term"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spotify_get</span><span class="op">(</span></span>
<span>    <span class="va">token</span>,</span>
<span>    <span class="st">"/v1/me/top/artists"</span>,</span>
<span>    query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="va">limit</span>, time_range <span class="op">=</span> <span class="va">time_range</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">items</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">items</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">item</span> <span class="op">&lt;-</span> <span class="va">items</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      name <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_character_</span>,</span>
<span>      genres <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">genres</span> <span class="op">|&gt;</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu">flatten</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        collapse <span class="op">=</span> <span class="st">", "</span></span>
<span>      <span class="op">)</span>,</span>
<span>      popularity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">popularity</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_real_</span>,</span>
<span>      followers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">followers</span><span class="op">$</span><span class="va">total</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_real_</span><span class="op">)</span>,</span>
<span>      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Get recently played tracks</span></span>
<span><span class="va">get_recently_played</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span>, <span class="va">limit</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spotify_get</span><span class="op">(</span></span>
<span>    <span class="va">token</span>,</span>
<span>    <span class="st">"/v1/me/player/recently-played"</span>,</span>
<span>    query <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="va">limit</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">items</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">items</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">item</span> <span class="op">&lt;-</span> <span class="va">items</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      played_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">played_at</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_character_</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>,</span>
<span>      track <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">track</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_character_</span>,</span>
<span>      artist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">track</span><span class="op">$</span><span class="va">artists</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>      album <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">track</span><span class="op">$</span><span class="va">album</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_character_</span>,</span>
<span>      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Currently playing (may be NULL if nothing is playing)</span></span>
<span><span class="va">get_currently_playing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">spotify_get_maybe_empty</span><span class="op">(</span><span class="va">token</span>, <span class="st">"/v1/me/player/currently-playing"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Normalize essential fields with guards</span></span>
<span>  <span class="va">item</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">item</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">item</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">artists</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">artists</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">artists</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">artists</span><span class="op">$</span><span class="va">name</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="st">"—"</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="st">"—"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">art_url</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">item</span><span class="op">$</span><span class="va">album</span><span class="op">$</span><span class="va">images</span><span class="op">$</span><span class="va">url</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    is_playing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">is_playing</span><span class="op">)</span>,</span>
<span>    progress_ms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">progress_ms</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_real_</span><span class="op">)</span>,</span>
<span>    duration_ms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">item</span><span class="op">$</span><span class="va">duration_ms</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="cn">NA_real_</span><span class="op">)</span>,</span>
<span>    track <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span>,</span>
<span>    artist <span class="op">=</span> <span class="va">artists</span>,</span>
<span>    album <span class="op">=</span> <span class="va">item</span><span class="op">$</span><span class="va">album</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span>,</span>
<span>    art <span class="op">=</span> <span class="va">art_url</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Helper to safely validate data frames returned from API calls</span></span>
<span><span class="va">safe_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Format milliseconds to m:ss</span></span>
<span><span class="va">format_ms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ms</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"—"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%d:%02d"</span>, <span class="va">s</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">60</span>, <span class="va">s</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">60</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Shiny app --------------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">## Theme &amp; CSS -----------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># Some basic Bootstrap theming</span></span>
<span><span class="va">spotify_theme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bs_theme.html" class="external-link">bs_theme</a></span><span class="op">(</span></span>
<span>  version <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  base_font <span class="op">=</span> <span class="fu"><a href="https://rstudio.github.io/sass/reference/font_face.html" class="external-link">font_google</a></span><span class="op">(</span><span class="st">"Inter"</span><span class="op">)</span>,</span>
<span>  heading_font <span class="op">=</span> <span class="fu"><a href="https://rstudio.github.io/sass/reference/font_face.html" class="external-link">font_google</a></span><span class="op">(</span><span class="st">"Space Grotesk"</span><span class="op">)</span>,</span>
<span>  bg <span class="op">=</span> <span class="st">"#121212"</span>,</span>
<span>  fg <span class="op">=</span> <span class="st">"#F5F6F8"</span>,</span>
<span>  primary <span class="op">=</span> <span class="st">"#1DB954"</span>,</span>
<span>  secondary <span class="op">=</span> <span class="st">"#191414"</span>,</span>
<span>  success <span class="op">=</span> <span class="st">"#1ED760"</span>,</span>
<span>  <span class="st">"navbar-bg"</span> <span class="op">=</span> <span class="st">"#0F0F0F"</span>,</span>
<span>  <span class="st">"card-border-color"</span> <span class="op">=</span> <span class="st">"#1DB95433"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add CSS</span></span>
<span><span class="va">spotify_theme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bs_bundle.html" class="external-link">bs_add_rules</a></span><span class="op">(</span></span>
<span>  <span class="va">spotify_theme</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"body { background: radial-gradient(circle at top left, #1DB95411, #121212 55%); }"</span>,</span>
<span>    <span class="st">".navbar-dark { border-bottom: 1px solid #1DB95422; }"</span>,</span>
<span>    <span class="st">".card { background-color: #181818; border-radius: 18px; box-shadow: 0 18px 30px -24px rgba(0,0,0,0.7); transition: transform 0.2s, box-shadow 0.2s; }"</span>,</span>
<span>    <span class="st">".card:hover { box-shadow: 0 20px 35px -20px rgba(29, 185, 84, 0.3); }"</span>,</span>
<span>    <span class="st">".card-header { background-color: rgba(29, 185, 84, 0.08); border-bottom: 1px solid rgba(29, 185, 84, 0.2); font-weight: 600; }"</span>,</span>
<span>    <span class="st">".profile-avatar { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 0 3px #1DB95455; transition: box-shadow 0.3s; }"</span>,</span>
<span>    <span class="st">".profile-avatar:hover { box-shadow: 0 0 0 4px #1DB954; }"</span>,</span>
<span>    <span class="st">".login-hero { min-height: 60vh; }"</span>,</span>
<span>    <span class="st">".login-card { background: linear-gradient(130deg, #1DB954 0%, #1AA34A 55%, #121212 100%); color: #0C0C0C; border: none; }"</span>,</span>
<span>    <span class="st">".login-card .btn { background-color: #121212; color: #F5F6F8; border: none; transition: all 0.3s; }"</span>,</span>
<span>    <span class="st">".login-card .btn:hover { background-color: #0f0f0f; color: #1DB954; transform: scale(1.05); }"</span>,</span>
<span>    <span class="st">".value-box { background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%); border: 1px solid #1DB95433; border-radius: 12px; transition: border-color 0.3s; padding: 0.6rem 0.9rem !important; }"</span>,</span>
<span>    <span class="st">".value-box:hover { border-color: #1DB95466; }"</span>,</span>
<span>    <span class="st">".value-box .value { font-size: 1.3rem; font-weight: 700; color: #1DB954; line-height: 1.2; }"</span>,</span>
<span>    <span class="st">".value-box .value-box-title, .value-box h6, .value-box .title { font-size: 0.85rem; letter-spacing: .02em; opacity: .95; }"</span>,</span>
<span>    <span class="st">".value-box p { margin-bottom: 0; font-size: 0.9rem; }"</span>,</span>
<span>    <span class="st">".value-box .showcase-icon { color: #1DB954; opacity: 0.7; }"</span>,</span>
<span>    <span class="st">".table { color: #F5F6F8; margin-bottom: 0; }"</span>,</span>
<span>    <span class="st">".table thead { color: #1DB954; font-weight: 600; border-bottom: 2px solid #1DB95444; }"</span>,</span>
<span>    <span class="st">".table tbody tr { transition: background-color 0.2s; }"</span>,</span>
<span>    <span class="st">".table tbody tr:hover { background-color: rgba(29, 185, 84, 0.15); }"</span>,</span>
<span>    <span class="st">".table td { vertical-align: middle; padding: 0.75rem; }"</span>,</span>
<span>    <span class="st">".table td:first-child { color: #1DB954; font-weight: 600; width: 40px; text-align: center; }"</span>,</span>
<span>    <span class="st">".control-card { background: rgba(16, 16, 16, 0.7); border: 1px solid #1DB95422; }"</span>,</span>
<span>    <span class="st">".badge { font-size: 0.85rem; padding: 0.4em 0.8em; }"</span>,</span>
<span>    <span class="st">".play-count-badge { background: linear-gradient(135deg, #1DB954 0%, #1AA34A 100%); color: #000; font-weight: 700; }"</span>,</span>
<span>    <span class="st">".navbar .navbar-nav { display: none !important; }"</span>,</span>
<span>    sep <span class="op">=</span> <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subtle readability and responsive polish overrides</span></span>
<span><span class="va">spotify_theme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bs_bundle.html" class="external-link">bs_add_rules</a></span><span class="op">(</span></span>
<span>  <span class="va">spotify_theme</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"/* Ensure cards don't collapse too small on narrow screens */"</span>,</span>
<span>    <span class="st">".card { min-width: 300px; }"</span>,</span>
<span>    <span class="st">"/* Avoid horizontal scroll within cards */"</span>,</span>
<span>    <span class="st">".card .card-body { overflow-x: hidden; }"</span>,</span>
<span>    <span class="st">"/* Add gap between cards in layout_columns */"</span>,</span>
<span>    <span class="st">".bslib-grid { gap: 1rem !important; }"</span>,</span>
<span>    <span class="st">"/* Ensure proper wrapping for cards - prevent cards from becoming too narrow */"</span>,</span>
<span>    <span class="st">".bslib-grid &gt; div { min-width: 300px; flex: 1 1 300px; }"</span>,</span>
<span>    <span class="st">"/* Prevent value box containers from collapsing */"</span>,</span>
<span>    <span class="st">".card-body .bslib-grid { display: flex; flex-wrap: wrap; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Softer login gradient and better contrast */"</span>,</span>
<span>    <span class="st">".login-card { background: linear-gradient(145deg, rgba(29,185,84,0.18) 0%, rgba(29,185,84,0.08) 38%, #1a1a1a 100%); color: #F5F6F8; border: 1px solid #1DB95422; overflow: hidden; }"</span>,</span>
<span>    <span class="st">".login-card .btn { background-color: #121212; color: #F5F6F8; border: 1px solid #1DB95444; transition: background-color 0.25s, color 0.25s, box-shadow 0.25s; }"</span>,</span>
<span>    <span class="st">".login-card .btn:hover { background-color: #0f0f0f; color: #1DB954; box-shadow: 0 8px 22px rgba(29,185,84,0.22); }"</span>,</span>
<span>    <span class="st">".login-card .btn:focus, .login-card .btn:focus-visible { outline: none; box-shadow: 0 0 0 0.2rem rgba(29,185,84,0.35); }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Improve muted text contrast inside cards/value boxes */"</span>,</span>
<span>    <span class="st">".card .text-muted, .value-box .text-muted { color: #CFD3D8 !important; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* DataTables dark theme tweaks */"</span>,</span>
<span>    <span class="st">".dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input { background-color: #0f0f0f; color: #F5F6F8; border: 1px solid #1DB95433; }"</span>,</span>
<span>    <span class="st">".dataTables_wrapper .dataTables_paginate .paginate_button { color: #F5F6F8 !important; border: 1px solid transparent; }"</span>,</span>
<span>    <span class="st">".dataTables_wrapper .dataTables_paginate .paginate_button.current, .dataTables_wrapper .dataTables_paginate .paginate_button:hover { color: #1DB954 !important; background: #0f0f0f; border-color: #1DB95433; }"</span>,</span>
<span>    <span class="st">".dataTables_wrapper .dataTables_info { color: #E4E7EB; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Slightly more visible table header border for clarity */"</span>,</span>
<span>    <span class="st">".table thead { border-bottom: 2px solid #1DB95455; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Custom Spotify outline button (for Sign out) */"</span>,</span>
<span>    <span class="st">".btn-spotify-outline { color: #1DB954; border: 1px solid #1DB95499; background: transparent; }"</span>,</span>
<span>    <span class="st">".btn-spotify-outline:hover { color: #0b0b0b; background: #1DB954; border-color: #1DB954; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Plan badge for better readability */"</span>,</span>
<span>    <span class="st">".badge-plan { background: transparent; border: 1px solid #1DB95466; color: #F5F6F8; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Sidebar toggle visibility */"</span>,</span>
<span>    <span class="st">".layout-sidebar .collapse-toggle, .layout-sidebar .sidebar-toggle, .bslib-sidebar-layout .collapse-toggle { color: #F5F6F8; border: 1px solid #1DB95455; background: #0f0f0f; }"</span>,</span>
<span>    <span class="st">".layout-sidebar .collapse-toggle:hover, .layout-sidebar .sidebar-toggle:hover, .bslib-sidebar-layout .collapse-toggle:hover { border-color: #1DB954aa; color: #1DB954; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Value box compact sizing and min width with proper wrapping */"</span>,</span>
<span>    <span class="st">".value-box { min-width: 220px; margin-bottom: 0.75rem; flex: 1 1 220px; }"</span>,</span>
<span>    <span class="st">".value-box .showcase-top, .value-box .showcase-bottom, .value-box .showcase-area { gap: .5rem; }"</span>,</span>
<span>    <span class="st">".value-box .showcase-icon { font-size: 0.95rem; }"</span>,</span>
<span>    <span class="st">"/* Prevent value box text overflow */"</span>,</span>
<span>    <span class="st">".value-box .value { word-break: break-word; font-size: 1.1rem !important; }"</span>,</span>
<span>    <span class="st">".value-box p { word-break: break-word; overflow-wrap: break-word; font-size: 0.85rem; }"</span>,</span>
<span>    <span class="st">".value-box .title, .value-box h6 { font-size: 0.8rem; }"</span>,</span>
<span></span>
<span>    <span class="st">"/* Now playing artwork sizing */"</span>,</span>
<span>    <span class="st">".now-playing-art { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; box-shadow: 0 8px 18px rgba(0,0,0,.35); }"</span>,</span>
<span></span>
<span>    sep <span class="op">=</span> <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## UI --------------------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">bslib</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/bslib/reference/page.html" class="external-link">page_fluid</a></span><span class="op">(</span></span>
<span>  title <span class="op">=</span> <span class="va">tags</span><span class="op">$</span><span class="fu">span</span><span class="op">(</span></span>
<span>    class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"headphones"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"fw-semibold"</span>, <span class="st">"Spotify Listening Studio"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  theme <span class="op">=</span> <span class="va">spotify_theme</span>,</span>
<span>  <span class="fu"><a href="../reference/use_shinyOAuth.html">use_shinyOAuth</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>    class <span class="op">=</span> <span class="st">"pt-4 pb-5"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html" class="external-link">uiOutput</a></span><span class="op">(</span><span class="st">"oauth_error"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/conditionalPanel.html" class="external-link">conditionalPanel</a></span><span class="op">(</span></span>
<span>      condition <span class="op">=</span> <span class="st">"output.isAuthenticated"</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/sidebar.html" class="external-link">layout_sidebar</a></span><span class="op">(</span></span>
<span>        sidebar <span class="op">=</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/sidebar.html" class="external-link">sidebar</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            class <span class="op">=</span> <span class="st">"control-card"</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"sliders-h"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Personalize view"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html" class="external-link">selectInput</a></span><span class="op">(</span></span>
<span>                <span class="st">"time_range"</span>,</span>
<span>                <span class="st">"Listening window"</span>,</span>
<span>                choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                  <span class="st">"Last 4 weeks"</span> <span class="op">=</span> <span class="st">"short_term"</span>,</span>
<span>                  <span class="st">"Last 6 months"</span> <span class="op">=</span> <span class="st">"medium_term"</span>,</span>
<span>                  <span class="st">"All-time favorites"</span> <span class="op">=</span> <span class="st">"long_term"</span></span>
<span>                <span class="op">)</span>,</span>
<span>                selected <span class="op">=</span> <span class="st">"short_term"</span></span>
<span>              <span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html" class="external-link">sliderInput</a></span><span class="op">(</span></span>
<span>                <span class="st">"top_limit"</span>,</span>
<span>                <span class="st">"Top items"</span>,</span>
<span>                min <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                max <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                value <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                step <span class="op">=</span> <span class="fl">1</span></span>
<span>              <span class="op">)</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_footer</a></span><span class="op">(</span><span class="va">tags</span><span class="op">$</span><span class="fu">small</span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"text-muted"</span>,</span>
<span>              <span class="st">"Adjust filters to explore different eras of your listening."</span></span>
<span>            <span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          width <span class="op">=</span> <span class="fl">320</span>,</span>
<span>          open <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>        <span class="op">)</span>,</span>
<span>        fillable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/bslib/reference/layout_column_wrap.html" class="external-link">layout_column_wrap</a></span><span class="op">(</span></span>
<span>          width <span class="op">=</span> <span class="st">"350px"</span>,</span>
<span>          heights_equal <span class="op">=</span> <span class="st">"row"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"user"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Profile"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html" class="external-link">uiOutput</a></span><span class="op">(</span><span class="st">"profile"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"play-circle"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Listening sessions"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html" class="external-link">uiOutput</a></span><span class="op">(</span><span class="st">"summary_boxes"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"broadcast-tower"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Now playing"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html" class="external-link">uiOutput</a></span><span class="op">(</span><span class="st">"now_playing"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/bslib/reference/layout_column_wrap.html" class="external-link">layout_column_wrap</a></span><span class="op">(</span></span>
<span>          width <span class="op">=</span> <span class="st">"400px"</span>,</span>
<span>          fill <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"music"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Top tracks"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu">DTOutput</span><span class="op">(</span><span class="st">"top_tracks"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"users"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Top artists"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu">DTOutput</span><span class="op">(</span><span class="st">"top_artists"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/bslib/reference/layout_column_wrap.html" class="external-link">layout_column_wrap</a></span><span class="op">(</span></span>
<span>          width <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>          fill <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          style <span class="op">=</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/css.html" class="external-link">css</a></span><span class="op">(</span>grid_template_columns <span class="op">=</span> <span class="st">"3fr 2fr"</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"history"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Recent plays"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu">DTOutput</span><span class="op">(</span><span class="st">"recent"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_header</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-2"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"chart-bar"</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span><span class="st">"Artists on repeat"</span><span class="op">)</span></span>
<span>            <span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html" class="external-link">plotOutput</a></span><span class="op">(</span><span class="st">"recent_artist_plot"</span>, height <span class="op">=</span> <span class="st">"400px"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/conditionalPanel.html" class="external-link">conditionalPanel</a></span><span class="op">(</span></span>
<span>      condition <span class="op">=</span> <span class="st">"!output.isAuthenticated"</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"login-hero d-flex justify-content-center align-items-center"</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card.html" class="external-link">card</a></span><span class="op">(</span></span>
<span>          class <span class="op">=</span> <span class="st">"login-card text-center p-5"</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/bslib/reference/card_body.html" class="external-link">card_body</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"headphones"</span>, class <span class="op">=</span> <span class="st">"display-4 mb-3"</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">h2</a></span><span class="op">(</span><span class="st">"Spotify Listening Studio"</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"lead"</span>,</span>
<span>              <span class="st">"Sign in to reveal your personal soundtrack: relive your top tracks, spotlight your favorite artists, and surface the songs you can't stop replaying."</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html" class="external-link">actionButton</a></span><span class="op">(</span></span>
<span>              <span class="st">"login"</span>,</span>
<span>              <span class="st">"Sign in with Spotify"</span>,</span>
<span>              class <span class="op">=</span> <span class="st">"btn btn-lg px-4 py-3 mt-2"</span></span>
<span>            <span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>              class <span class="op">=</span> <span class="st">"mt-3 small"</span>,</span>
<span>              <span class="va">tags</span><span class="op">$</span><span class="fu">strong</span><span class="op">(</span><span class="st">"Scopes:"</span><span class="op">)</span>,</span>
<span>              <span class="st">" user-top-read • user-read-recently-played • user-read-email • user-read-private"</span></span>
<span>            <span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Server ----------------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Handle Spotify login -------------------------------------------------------</span></span>
<span></span>
<span>  <span class="va">auth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_module_server.html">oauth_module_server</a></span><span class="op">(</span><span class="st">"auth"</span>, <span class="va">client</span>, auto_redirect <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Expose auth state to JS for our conditionalPanel</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">isAuthenticated</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">authenticated</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/outputOptions.html" class="external-link">outputOptions</a></span><span class="op">(</span><span class="va">output</span>, <span class="st">"isAuthenticated"</span>, suspendWhenHidden <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">login</span>, <span class="op">{</span></span>
<span>    <span class="va">auth</span><span class="op">$</span><span class="fu">request_login</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">logout</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">authenticated</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">auth</span><span class="op">$</span><span class="fu">logout</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">oauth_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html" class="external-link">renderUI</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">error</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">msg</span> <span class="op">&lt;-</span> <span class="va">auth</span><span class="op">$</span><span class="va">error</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">error_description</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">msg</span>, <span class="st">": "</span>, <span class="va">auth</span><span class="op">$</span><span class="va">error_description</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"alert alert-danger"</span>, role <span class="op">=</span> <span class="st">"alert"</span>, <span class="va">msg</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Show user profile ----------------------------------------------------------</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html" class="external-link">renderUI</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span><span class="op">)</span></span>
<span>    <span class="va">user_info</span> <span class="op">&lt;-</span> <span class="va">auth</span><span class="op">$</span><span class="va">token</span><span class="op">@</span><span class="va">userinfo</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="st">"No user info"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">avatar</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">images</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">images</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">images</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">img_url</span> <span class="op">&lt;-</span> <span class="va">user_info</span><span class="op">$</span><span class="va">images</span><span class="op">$</span><span class="va">url</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">img_url</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">img_url</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">avatar</span> <span class="op">&lt;-</span> <span class="va">tags</span><span class="op">$</span><span class="fu">img</span><span class="op">(</span></span>
<span>          src <span class="op">=</span> <span class="va">img_url</span>,</span>
<span>          class <span class="op">=</span> <span class="st">"profile-avatar"</span>,</span>
<span>          alt <span class="op">=</span> <span class="st">"User avatar"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">display_name</span> <span class="op">&lt;-</span> <span class="va">user_info</span><span class="op">$</span><span class="va">display_name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="va">user_info</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"&lt;unknown&gt;"</span></span>
<span></span>
<span>    <span class="va">followers_badge</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">followers</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">followers</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">followers</span><span class="op">$</span><span class="va">total</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">followers_badge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"badge bg-success-subtle text-success-emphasis"</span>,</span>
<span>        <span class="st">"Followers:"</span>,</span>
<span>        <span class="va">tags</span><span class="op">$</span><span class="fu">span</span><span class="op">(</span></span>
<span>          class <span class="op">=</span> <span class="st">"ms-1"</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">followers</span><span class="op">$</span><span class="va">total</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">plan_badge</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">product</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">plan_badge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"badge badge-plan"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Plan:"</span>, <span class="va">user_info</span><span class="op">$</span><span class="va">product</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">country_badge</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">country_badge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"badge bg-dark border border-success"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Country:"</span>, <span class="va">user_info</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">spotify_link</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">external_urls</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">external_urls</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">external_urls</span><span class="op">$</span><span class="va">spotify</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spotify_link</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">a</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"external-link-alt"</span>, class <span class="op">=</span> <span class="st">"ms-2"</span><span class="op">)</span>,</span>
<span>        href <span class="op">=</span> <span class="va">user_info</span><span class="op">$</span><span class="va">external_urls</span><span class="op">$</span><span class="va">spotify</span>,</span>
<span>        class <span class="op">=</span> <span class="st">"text-decoration-none text-success"</span>,</span>
<span>        target <span class="op">=</span> <span class="st">"_blank"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Open in Spotify"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/tagList.html" class="external-link">tagList</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"d-flex align-items-center gap-3 flex-wrap"</span>,</span>
<span>        <span class="va">avatar</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">h4</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"mb-1"</span>, <span class="va">display_name</span>, <span class="va">spotify_link</span><span class="op">)</span>,</span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">$</span><span class="va">email</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="va">user_info</span><span class="op">$</span><span class="va">email</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>          class <span class="op">=</span> <span class="st">"ms-auto"</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html" class="external-link">actionButton</a></span><span class="op">(</span></span>
<span>            <span class="st">"logout"</span>,</span>
<span>            <span class="st">"Sign out"</span>,</span>
<span>            class <span class="op">=</span> <span class="st">"btn btn-spotify-outline btn-sm"</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">hr</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"border-success-subtle"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"d-flex flex-wrap gap-2"</span>,</span>
<span>        <span class="va">followers_badge</span>,</span>
<span>        <span class="va">plan_badge</span>,</span>
<span>        <span class="va">country_badge</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Reactives containing Spotify data ------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># Data fetch reactives</span></span>
<span>  <span class="va">top_tracks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span>, <span class="va">input</span><span class="op">$</span><span class="va">time_range</span>, <span class="va">input</span><span class="op">$</span><span class="va">top_limit</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span></span>
<span>      <span class="fu">get_top_tracks</span><span class="op">(</span></span>
<span>        <span class="va">auth</span><span class="op">$</span><span class="va">token</span>,</span>
<span>        limit <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">top_limit</span>,</span>
<span>        time_range <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">time_range</span></span>
<span>      <span class="op">)</span>,</span>
<span>      silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">top_artists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span>, <span class="va">input</span><span class="op">$</span><span class="va">time_range</span>, <span class="va">input</span><span class="op">$</span><span class="va">top_limit</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span></span>
<span>      <span class="fu">get_top_artists</span><span class="op">(</span></span>
<span>        <span class="va">auth</span><span class="op">$</span><span class="va">token</span>,</span>
<span>        limit <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">top_limit</span>,</span>
<span>        time_range <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">time_range</span></span>
<span>      <span class="op">)</span>,</span>
<span>      silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">recent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">get_recently_played</span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span>, limit <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">summary_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">tracks_df</span> <span class="op">&lt;-</span> <span class="fu">safe_df</span><span class="op">(</span><span class="fu">top_tracks</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">artists_df</span> <span class="op">&lt;-</span> <span class="fu">safe_df</span><span class="op">(</span><span class="fu">top_artists</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">recent_df</span> <span class="op">&lt;-</span> <span class="fu">safe_df</span><span class="op">(</span><span class="fu">recent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      top_track <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">tracks_df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          name <span class="op">=</span> <span class="va">tracks_df</span><span class="op">$</span><span class="va">name</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span>,</span>
<span>          artist <span class="op">=</span> <span class="va">tracks_df</span><span class="op">$</span><span class="va">artist</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="cn">NULL</span></span>
<span>      <span class="op">}</span>,</span>
<span>      top_artist <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">artists_df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          name <span class="op">=</span> <span class="va">artists_df</span><span class="op">$</span><span class="va">name</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span>,</span>
<span>          genres <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span></span>
<span>            <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">artists_df</span><span class="op">$</span><span class="va">genres</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">artists_df</span><span class="op">$</span><span class="va">genres</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>          <span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">artists_df</span><span class="op">$</span><span class="va">genres</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>          <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>            <span class="st">"—"</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="cn">NULL</span></span>
<span>      <span class="op">}</span>,</span>
<span>      last_play <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">recent_df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          track <span class="op">=</span> <span class="va">recent_df</span><span class="op">$</span><span class="va">track</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span>,</span>
<span>          artist <span class="op">=</span> <span class="va">recent_df</span><span class="op">$</span><span class="va">artist</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span>,</span>
<span>          played_at <span class="op">=</span> <span class="va">recent_df</span><span class="op">$</span><span class="va">played_at</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="cn">NULL</span></span>
<span>      <span class="op">}</span>,</span>
<span>      unique_recent <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">recent_df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">recent_df</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="cn">NA_integer_</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Summary cards --------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># These show a few different summary stats about the user's listening</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">summary_boxes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html" class="external-link">renderUI</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">summary_data</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">top_track</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">top_track</span></span>
<span>    <span class="va">top_artist</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">top_artist</span></span>
<span>    <span class="va">last_play</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">last_play</span></span>
<span></span>
<span>    <span class="va">top_track_name</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">top_track</span><span class="op">)</span><span class="op">)</span> <span class="va">top_track</span><span class="op">$</span><span class="va">name</span> <span class="kw">else</span> <span class="st">"—"</span></span>
<span>    <span class="va">top_track_artist</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">top_track</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">top_track</span><span class="op">$</span><span class="va">artist</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="st">"No data for this window"</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">top_artist_name</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">top_artist</span><span class="op">)</span><span class="op">)</span> <span class="va">top_artist</span><span class="op">$</span><span class="va">name</span> <span class="kw">else</span> <span class="st">"—"</span></span>
<span>    <span class="va">top_artist_genres</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">top_artist</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">top_artist</span><span class="op">$</span><span class="va">genres</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="st">"No genres available"</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">last_track_name</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">last_play</span><span class="op">)</span><span class="op">)</span> <span class="va">last_play</span><span class="op">$</span><span class="va">track</span> <span class="kw">else</span> <span class="st">"—"</span></span>
<span>    <span class="va">last_track_details</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">last_play</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">parts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">last_play</span><span class="op">$</span><span class="va">artist</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"—"</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">last_play</span><span class="op">$</span><span class="va">played_at</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">last_play</span><span class="op">$</span><span class="va">played_at</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">parts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">parts</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">last_play</span><span class="op">$</span><span class="va">played_at</span>, <span class="st">"%b %d • %H:%M"</span>, tz <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">parts</span>, collapse <span class="op">=</span> <span class="st">"  |  "</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="st">"No recent playback"</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">unique_recent</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">unique_recent</span></span>
<span>    <span class="va">unique_recent_value</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">unique_recent</span><span class="op">)</span><span class="op">)</span> <span class="va">unique_recent</span> <span class="kw">else</span> <span class="st">"—"</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rstudio.github.io/bslib/reference/layout_column_wrap.html" class="external-link">layout_column_wrap</a></span><span class="op">(</span></span>
<span>      width <span class="op">=</span> <span class="st">"220px"</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/value_box.html" class="external-link">value_box</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Top Track"</span>,</span>
<span>        value <span class="op">=</span> <span class="va">top_track_name</span>,</span>
<span>        showcase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"music"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="va">top_track_artist</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/value_box.html" class="external-link">value_box</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Top Artist"</span>,</span>
<span>        value <span class="op">=</span> <span class="va">top_artist_name</span>,</span>
<span>        showcase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"star"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="va">top_artist_genres</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/value_box.html" class="external-link">value_box</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Recent Session"</span>,</span>
<span>        value <span class="op">=</span> <span class="va">last_track_name</span>,</span>
<span>        showcase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"clock"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="va">last_track_details</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/bslib/reference/value_box.html" class="external-link">value_box</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Unique Artists (recent)"</span>,</span>
<span>        value <span class="op">=</span> <span class="va">unique_recent_value</span>,</span>
<span>        showcase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/icon.html" class="external-link">icon</a></span><span class="op">(</span><span class="st">"users"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="st">"Across your latest 50 plays"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Top tracks -----------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># Shows the user's top tracks in a data table</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">top_tracks</span> <span class="op">&lt;-</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">top_tracks</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">validate</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"try-error"</span><span class="op">)</span>, <span class="st">"Failed to load top tracks"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"No tracks returned for this window"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Calculate play counts from recent plays</span></span>
<span>    <span class="va">recent_df</span> <span class="op">&lt;-</span> <span class="fu">safe_df</span><span class="op">(</span><span class="fu">recent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">recent_df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">recent_df</span><span class="op">$</span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">recent_df</span><span class="op">$</span><span class="va">track</span>, <span class="st">" — "</span>, <span class="va">recent_df</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span></span>
<span>      <span class="va">df</span><span class="op">$</span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">name</span>, <span class="st">" — "</span>, <span class="va">df</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span></span>
<span>      <span class="va">play_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">recent_df</span><span class="op">$</span><span class="va">key</span><span class="op">)</span></span>
<span>      <span class="va">df</span><span class="op">$</span><span class="va">plays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>        <span class="va">df</span><span class="op">$</span><span class="va">key</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">play_counts</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="fl">0L</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">df</span><span class="op">$</span><span class="va">plays</span> <span class="op">&lt;-</span> <span class="fl">0L</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Drop rows that are entirely missing name &amp; artist</span></span>
<span>    <span class="va">keep</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">name</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span></span>
<span>      <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">keep</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"artist"</span>, <span class="st">"album"</span>, <span class="st">"plays"</span>, <span class="st">"popularity"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">plays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">plays</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"🔁 %d"</span>, <span class="va">df</span><span class="op">$</span><span class="va">plays</span><span class="op">)</span>, <span class="st">"—"</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">popularity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">popularity</span><span class="op">)</span>,</span>
<span>      <span class="st">"—"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"⭐ %d"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">popularity</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add rank numbers</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>`#` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>      <span class="va">df</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="st">"Track"</span>, <span class="st">"Artist"</span>, <span class="st">"Album"</span>, <span class="st">"Recent Plays"</span>, <span class="st">"Popularity"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu">datatable</span><span class="op">(</span></span>
<span>      <span class="va">df</span>,</span>
<span>      rownames <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      escape <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        pageLength <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        lengthChange <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">'asc'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        columnDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>orderable <span class="op">=</span> <span class="cn">FALSE</span>, targets <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Top artists ----------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># Shows the user's top artists in a data table</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">top_artists</span> <span class="op">&lt;-</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">top_artists</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">validate</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"try-error"</span><span class="op">)</span>, <span class="st">"Failed to load top artists"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"No artists returned for this window"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"genres"</span>, <span class="st">"popularity"</span>, <span class="st">"followers"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">genres</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">genres</span> <span class="op">==</span> <span class="st">""</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"—"</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">genres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>      <span class="va">df</span><span class="op">$</span><span class="va">genres</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">50</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">g</span>, <span class="fl">1</span>, <span class="fl">47</span><span class="op">)</span>, <span class="st">"..."</span><span class="op">)</span> <span class="kw">else</span> <span class="va">g</span></span>
<span>      <span class="op">}</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">popularity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">popularity</span><span class="op">)</span>,</span>
<span>      <span class="st">"—"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"⭐ %d"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">popularity</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">followers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">followers</span><span class="op">)</span>,</span>
<span>      <span class="st">"—"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"👥 "</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">followers</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add rank numbers</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>`#` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>      <span class="va">df</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="st">"Artist"</span>, <span class="st">"Genres"</span>, <span class="st">"Popularity"</span>, <span class="st">"Followers"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu">datatable</span><span class="op">(</span></span>
<span>      <span class="va">df</span>,</span>
<span>      rownames <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      escape <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        pageLength <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        lengthChange <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">'asc'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        columnDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>orderable <span class="op">=</span> <span class="cn">FALSE</span>, targets <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Recent plays ---------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># Shows the user's recent plays in a data table</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">recent</span> <span class="op">&lt;-</span> <span class="fu">renderDT</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">recent</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">validate</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"try-error"</span><span class="op">)</span>, <span class="st">"Failed to load recent plays"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"No recent plays available"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">played</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">played_at</span>, <span class="st">"%b %d • %H:%M"</span>, tz <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"played"</span>, <span class="st">"track"</span>, <span class="st">"artist"</span>, <span class="st">"album"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Add rank numbers</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>`#` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="va">df</span><span class="op">)</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#"</span>, <span class="st">"Played"</span>, <span class="st">"Track"</span>, <span class="st">"Artist"</span>, <span class="st">"Album"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">datatable</span><span class="op">(</span></span>
<span>      <span class="va">df</span>,</span>
<span>      rownames <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        pageLength <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        lengthChange <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">'desc'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        columnDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>orderable <span class="op">=</span> <span class="cn">FALSE</span>, targets <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Recent artists plot --------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># Bar plot of most frequently played artists in recent plays</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">recent_artist_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html" class="external-link">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">df_recent</span> <span class="op">&lt;-</span> <span class="fu">recent</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">validate</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">df_recent</span>, <span class="st">"try-error"</span><span class="op">)</span>, <span class="st">"Failed to load recent plays"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/validate.html" class="external-link">need</a></span><span class="op">(</span></span>
<span>        <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">df_recent</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df_recent</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,</span>
<span>        <span class="st">"No recent plays available"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Primary: counts from recent plays</span></span>
<span>    <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">df_recent</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">counts_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      artist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span>,</span>
<span>      plays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span>,</span>
<span>      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># If the recent signal is weak (&lt;= 3 artists or max &lt;= 1), fall back to time-range top artists by popularity</span></span>
<span>    <span class="va">use_fallback</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">counts_df</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">3</span> <span class="op">||</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">counts_df</span><span class="op">$</span><span class="va">plays</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">use_fallback</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">df_top</span> <span class="op">&lt;-</span> <span class="fu">safe_df</span><span class="op">(</span><span class="fu">top_artists</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">df_top</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df_top</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">counts_df</span> <span class="op">&lt;-</span> <span class="va">df_top</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"popularity"</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">counts_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"artist"</span>, <span class="st">"plays"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Take top 10 and order for plotting</span></span>
<span>    <span class="va">counts_df</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span></span>
<span>      <span class="va">counts_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">counts_df</span><span class="op">$</span><span class="va">plays</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span>,</span>
<span>      <span class="fl">10L</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">counts_df</span><span class="op">$</span><span class="va">artist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">counts_df</span><span class="op">$</span><span class="va">artist</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">counts_df</span><span class="op">$</span><span class="va">artist</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">x_lab</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">use_fallback</span><span class="op">)</span><span class="op">)</span> <span class="st">"Popularity"</span> <span class="kw">else</span> <span class="st">"Plays (last 50)"</span></span>
<span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="va">counts_df</span>, <span class="fu">aes_string</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"plays"</span>, y <span class="op">=</span> <span class="st">"artist"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_col</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#1DB954"</span>, width <span class="op">=</span> <span class="fl">0.65</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">plays</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">"#F5F6F8"</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">scale_x_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>mult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.08</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_lab</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">theme_minimal</span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Inter"</span>, base_size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">theme</span><span class="op">(</span></span>
<span>        plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#181818"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#181818"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>        panel.grid.major.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#FFFFFF22"</span><span class="op">)</span>,</span>
<span>        text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#F5F6F8"</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#F5F6F8"</span>, size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#F5F6F8"</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>        plot.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Now playing ----------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co"># Shows the user's currently playing track with a progress bar</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">now_playing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html" class="external-link">renderUI</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span><span class="op">)</span></span>
<span>    <span class="co"># refresh every 5 seconds</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/invalidateLater.html" class="external-link">invalidateLater</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="va">session</span><span class="op">)</span></span>
<span>    <span class="va">playing</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">get_currently_playing</span><span class="op">(</span><span class="va">auth</span><span class="op">$</span><span class="va">token</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">playing</span>, <span class="st">"try-error"</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">playing</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="st">"Nothing playing right now"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">pct</span> <span class="op">&lt;-</span> <span class="cn">NA_real_</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">progress_ms</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">duration_ms</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="va">playing</span><span class="op">$</span><span class="va">duration_ms</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">progress_ms</span> <span class="op">/</span> <span class="va">playing</span><span class="op">$</span><span class="va">duration_ms</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">progress_bar</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pct</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">progress_bar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"progress mt-2"</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>          class <span class="op">=</span> <span class="st">"progress-bar bg-success"</span>,</span>
<span>          role <span class="op">=</span> <span class="st">"progressbar"</span>,</span>
<span>          style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"width: "</span>, <span class="va">pct</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>          `aria-valuenow` <span class="op">=</span> <span class="va">pct</span>,</span>
<span>          `aria-valuemin` <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          `aria-valuemax` <span class="op">=</span> <span class="fl">100</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">time_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">span</a></span><span class="op">(</span></span>
<span>      class <span class="op">=</span> <span class="st">"small text-muted"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu">format_ms</span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">progress_ms</span><span class="op">)</span>, <span class="st">"/"</span>, <span class="fu">format_ms</span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">duration_ms</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/tagList.html" class="external-link">tagList</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>        class <span class="op">=</span> <span class="st">"d-flex gap-3 align-items-center"</span>,</span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">art</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">tags</span><span class="op">$</span><span class="fu">img</span><span class="op">(</span></span>
<span>            src <span class="op">=</span> <span class="va">playing</span><span class="op">$</span><span class="va">art</span>,</span>
<span>            class <span class="op">=</span> <span class="st">"now-playing-art"</span>,</span>
<span>            alt <span class="op">=</span> <span class="st">"Album art"</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"fw-semibold"</span>, <span class="va">playing</span><span class="op">$</span><span class="va">track</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"text-muted"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">playing</span><span class="op">$</span><span class="va">artist</span>, <span class="st">"•"</span>, <span class="va">playing</span><span class="op">$</span><span class="va">album</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="va">progress_bar</span>,</span>
<span>      <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">div</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"d-flex justify-content-end"</span>, <span class="va">time_label</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Run app ----------------------------------------------------------------------</span></span>
<span></span>
<span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/runApp.html" class="external-link">runApp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html" class="external-link">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span>, port <span class="op">=</span> <span class="fl">8100</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luka Koning.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create a custom cache backend (cachem-like) — custom_cache • shinyOAuth</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create a custom cache backend (cachem-like) — custom_cache"><meta name="description" content="Builds a minimal cachem-like cache backend object that exposes cachem-compatible methods:
$get(key, missing), $set(key, value), $remove(key), and $info().
Use this helper when you want to plug a custom state store or JWKS cache
into 'shinyOAuth', when cachem::cache_mem() or cachem::cache_disk()
are not suitable. This may be useful specifically when you deploy
a Shiny app to a multi-process environment with non-sticky workers.
In such cases, you may want to use a shared external cache (e.g., database,
Redis, Memcached).
The resulting object can be used in both places where 'shinyOAuth' accepts a cache-like object:
OAuthClient@state_store (requires $get, $set, $remove; optional $info)
OAuthProvider@jwks_cache (requires $get, $set; optional $remove, $info)


The $info() method is optional, but if provided and it returns a list with
max_age (seconds), shinyOAuth will align cookie/issued_at TTLs to that value."><meta property="og:description" content="Builds a minimal cachem-like cache backend object that exposes cachem-compatible methods:
$get(key, missing), $set(key, value), $remove(key), and $info().
Use this helper when you want to plug a custom state store or JWKS cache
into 'shinyOAuth', when cachem::cache_mem() or cachem::cache_disk()
are not suitable. This may be useful specifically when you deploy
a Shiny app to a multi-process environment with non-sticky workers.
In such cases, you may want to use a shared external cache (e.g., database,
Redis, Memcached).
The resulting object can be used in both places where 'shinyOAuth' accepts a cache-like object:
OAuthClient@state_store (requires $get, $set, $remove; optional $info)
OAuthProvider@jwks_cache (requires $get, $set; optional $remove, $info)


The $info() method is optional, but if provided and it returns a list with
max_age (seconds), shinyOAuth will align cookie/issued_at TTLs to that value."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shinyOAuth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/audit-logging.html">Audit logging and hooks</a></li>
    <li><a class="dropdown-item" href="../articles/authentication-flow.html">Authentication flow</a></li>
    <li><a class="dropdown-item" href="../articles/example-spotify.html">Example: Spotify login to display listening data</a></li>
    <li><a class="dropdown-item" href="../articles/usage.html">Usage</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lukakoning/shinyOAuth/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Create a custom cache backend (cachem-like)</h1>
      <small class="dont-index">Source: <a href="https://github.com/lukakoning/shinyOAuth/blob/master/R/custom_cache.R" class="external-link"><code>R/custom_cache.R</code></a></small>
      <div class="d-none name"><code>custom_cache.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Builds a minimal cachem-like cache backend object that exposes cachem-compatible methods:
<code>$get(key, missing)</code>, <code>$set(key, value)</code>, <code>$remove(key)</code>, and <code>$info()</code>.</p>
<p>Use this helper when you want to plug a custom state store or JWKS cache
into 'shinyOAuth', when <code><a href="https://cachem.r-lib.org/reference/cache_mem.html" class="external-link">cachem::cache_mem()</a></code> or <code><a href="https://cachem.r-lib.org/reference/cache_disk.html" class="external-link">cachem::cache_disk()</a></code>
are not suitable. This may be useful specifically when you deploy
a Shiny app to a multi-process environment with non-sticky workers.
In such cases, you may want to use a shared external cache (e.g., database,
Redis, Memcached).</p>
<p>The resulting object can be used in both places where 'shinyOAuth' accepts a cache-like object:</p><ul><li><p>OAuthClient@state_store (requires <code>$get</code>, <code>$set</code>, <code>$remove</code>; optional <code>$info</code>)</p></li>
<li><p>OAuthProvider@jwks_cache (requires <code>$get</code>, <code>$set</code>; optional <code>$remove</code>, <code>$info</code>)</p></li>
</ul><p>The <code>$info()</code> method is optional, but if provided and it returns a list with
<code>max_age</code> (seconds), shinyOAuth will align cookie/issued_at TTLs to that value.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">custom_cache</span><span class="op">(</span><span class="va">get</span>, <span class="va">set</span>, <span class="va">remove</span>, info <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-get">get<a class="anchor" aria-label="anchor" href="#arg-get"></a></dt>
<dd><p>A function(key, missing = NULL) -&gt; value. Required.
Should return the stored value, or the <code>missing</code> argument if the key is not present.
The <code>missing</code> parameter is mandatory because both <code>OAuthClient</code> and
<code>OAuthProvider</code> validators will pass it explicitly.</p></dd>


<dt id="arg-set">set<a class="anchor" aria-label="anchor" href="#arg-set"></a></dt>
<dd><p>A function(key, value) -&gt; invisible(NULL). Required.
Should store the value under the given key</p></dd>


<dt id="arg-remove">remove<a class="anchor" aria-label="anchor" href="#arg-remove"></a></dt>
<dd><p>A function(key) -&gt; logical or sentinel. Required.</p>
<p>For state stores, this enforces single-use eviction. If your backend performs
an atomic "get-and-delete" (e.g., SQL DELETE .. RETURNING), you may supply
a function which does nothing here but returns <code>TRUE</code>. (The login flow will always attempt to call
<code>$remove()</code> after <code>$get()</code> as a best-effort cleanup.)</p>
<p>Recommended contract for interoperability and strong replay protection:</p><ul><li><p>Return <code>TRUE</code> when a key was actually deleted or if it already did not exist</p></li>
<li><p>Return <code>FALSE</code> when they key could not be deleted or when it is unknown if
they key was deleted</p></li>
</ul><p>When the return value is not <code>TRUE</code>, 'shinyOAuth' will attempt to retrieve
the value from the state store to check if it may still be present; if that
fails (i.e., key is not present), it will treat the removal as succesful.
If it does find the key, it will produce an error indicating that removal
did not succeed.</p></dd>


<dt id="arg-info">info<a class="anchor" aria-label="anchor" href="#arg-info"></a></dt>
<dd><p>Function() -&gt; list(max_age = seconds, ...). Optional</p>
<p>This may be provided to because TTL information from <code>$info()</code> is used to
align browser cookie max age in <code><a href="oauth_module_server.html">oauth_module_server()</a></code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An R6 object exposing cachem-like <code>$get/$set/$remove/$info</code> methods</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">my_cache</span> <span class="op">&lt;-</span> <span class="fu">custom_cache</span><span class="op">(</span></span></span>
<span class="r-in"><span>  get <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span>, <span class="va">missing</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">get0</a></span><span class="op">(</span><span class="va">key</span>, envir <span class="op">=</span> <span class="va">mem</span>, ifnotfound <span class="op">=</span> <span class="va">missing</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  set <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span>, <span class="va">value</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="va">key</span>, <span class="va">value</span>, envir <span class="op">=</span> <span class="va">mem</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  remove <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="va">key</span>, envir <span class="op">=</span> <span class="va">mem</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="va">key</span>, envir <span class="op">=</span> <span class="va">mem</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co"># signal successful deletion</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co"># key did not exist</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  info <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>max_age <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Can be used as state_store:</span></span></span>
<span class="r-in"><span><span class="co"># oauth_client(..., state_store = my_cache)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Or as JWKS cache:</span></span></span>
<span class="r-in"><span><span class="co"># oauth_provider(..., jwks_cache = my_cache)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luka Koning.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>


<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Refresh an OAuth 2.0 token — refresh_token • shinyOAuth</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Refresh an OAuth 2.0 token — refresh_token"><meta name="description" content="Refreshes an OAuth session by obtaining a fresh access token using the
refresh token. When configured, also re-fetches userinfo and validates any
new ID token returned by the provider.
Per OIDC Core Section 12.2, providers may omit the ID token from refresh
responses. When omitted, the original ID token from the initial login is
preserved.
If the provider does return a new ID token during refresh, refresh_token()
requires that an original ID token from the initial login is available so it
can enforce subject continuity (OIDC 12.2: sub MUST match). If no original
ID token is available, refresh fails with an error.
When id_token_validation = TRUE, any refresh-returned ID token is also
fully validated (signature and claims) in addition to the OIDC 12.2 sub
continuity check.
When userinfo_required = TRUE, userinfo is re-fetched using the fresh
access token. If both a new ID token and fresh userinfo are present and
userinfo_id_token_match = TRUE, their subjects are verified to match."><meta property="og:description" content="Refreshes an OAuth session by obtaining a fresh access token using the
refresh token. When configured, also re-fetches userinfo and validates any
new ID token returned by the provider.
Per OIDC Core Section 12.2, providers may omit the ID token from refresh
responses. When omitted, the original ID token from the initial login is
preserved.
If the provider does return a new ID token during refresh, refresh_token()
requires that an original ID token from the initial login is available so it
can enforce subject continuity (OIDC 12.2: sub MUST match). If no original
ID token is available, refresh fails with an error.
When id_token_validation = TRUE, any refresh-returned ID token is also
fully validated (signature and claims) in addition to the OIDC 12.2 sub
continuity check.
When userinfo_required = TRUE, userinfo is re-fetched using the fresh
access token. If both a new ID token and fresh userinfo are present and
userinfo_id_token_match = TRUE, their subjects are verified to match."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shinyOAuth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/audit-logging.html">Audit logging and hooks</a></li>
    <li><a class="dropdown-item" href="../articles/authentication-flow.html">Authentication flow</a></li>
    <li><a class="dropdown-item" href="../articles/example-spotify.html">Example: Spotify login to display listening data</a></li>
    <li><a class="dropdown-item" href="../articles/usage.html">Usage</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lukakoning/shinyOAuth/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Refresh an OAuth 2.0 token</h1>
      <small class="dont-index">Source: <a href="https://github.com/lukakoning/shinyOAuth/blob/master/R/methods__token.R" class="external-link"><code>R/methods__token.R</code></a></small>
      <div class="d-none name"><code>refresh_token.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Refreshes an OAuth session by obtaining a fresh access token using the
refresh token. When configured, also re-fetches userinfo and validates any
new ID token returned by the provider.</p>
<p>Per OIDC Core Section 12.2, providers may omit the ID token from refresh
responses. When omitted, the original ID token from the initial login is
preserved.</p>
<p>If the provider does return a new ID token during refresh, <code>refresh_token()</code>
requires that an original ID token from the initial login is available so it
can enforce subject continuity (OIDC 12.2: <code>sub</code> MUST match). If no original
ID token is available, refresh fails with an error.</p>
<p>When <code>id_token_validation = TRUE</code>, any refresh-returned ID token is also
fully validated (signature and claims) in addition to the OIDC 12.2 <code>sub</code>
continuity check.</p>
<p>When <code>userinfo_required = TRUE</code>, userinfo is re-fetched using the fresh
access token. If both a new ID token and fresh userinfo are present and
<code>userinfo_id_token_match = TRUE</code>, their subjects are verified to match.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">refresh_token</span><span class="op">(</span></span>
<span>  <span class="va">oauth_client</span>,</span>
<span>  <span class="va">token</span>,</span>
<span>  async <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  introspect <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  shiny_session <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-oauth-client">oauth_client<a class="anchor" aria-label="anchor" href="#arg-oauth-client"></a></dt>
<dd><p><a href="OAuthClient.html">OAuthClient</a> object</p></dd>


<dt id="arg-token">token<a class="anchor" aria-label="anchor" href="#arg-token"></a></dt>
<dd><p><a href="OAuthToken.html">OAuthToken</a> object containing the refresh token</p></dd>


<dt id="arg-async">async<a class="anchor" aria-label="anchor" href="#arg-async"></a></dt>
<dd><p>Logical, default FALSE. If TRUE and the <a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai::mirai</a> package is
available, the refresh is performed off the main R session using
<code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai::mirai()</a></code> and this function returns a mirai (which implements
<code>as.promise()</code>) that resolves to an updated <code>OAuthToken</code>. Requires mirai
daemons to be configured with <code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">mirai::daemons()</a></code>.</p></dd>


<dt id="arg-introspect">introspect<a class="anchor" aria-label="anchor" href="#arg-introspect"></a></dt>
<dd><p>Logical, default FALSE. After a successful refresh, if the
provider exposes an introspection endpoint, perform a best-effort
introspection of the new access token for audit/diagnostics. The result
is not stored on the token object.</p></dd>


<dt id="arg-shiny-session">shiny_session<a class="anchor" aria-label="anchor" href="#arg-shiny-session"></a></dt>
<dd><p>Optional pre-captured Shiny session context (from
<code>capture_shiny_session_context()</code>) to include in audit events. Used when
calling from async workers that lack access to the reactive domain.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An updated <a href="OAuthToken.html">OAuthToken</a> object with refreshed credentials.</p>
<p><strong>What changes:</strong></p><ul><li><p><code>access_token</code>: Always updated to the fresh token</p></li>
<li><p><code>expires_at</code>: Computed from <code>expires_in</code> when provided; otherwise <code>Inf</code></p></li>
<li><p><code>refresh_token</code>: Updated if the provider rotates it; otherwise preserved</p></li>
<li><p><code>id_token</code>: Updated only if the provider returns one (and it validates);
otherwise the original from login is preserved</p></li>
<li><p><code>userinfo</code>: Refreshed if <code>userinfo_required = TRUE</code>; otherwise preserved</p></li>
</ul><p><strong>Validation failures cause errors:</strong> If the provider returns a new ID
token that fails validation (wrong issuer, audience, expired, or subject
mismatch with original), or if userinfo subject doesn't match the new ID
token, the refresh fails with an error. In <code><a href="oauth_module_server.html">oauth_module_server()</a></code>, this
clears the session and sets <code>authenticated = FALSE</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Please note: `get_userinfo()`, `introspect_token()`, and `refresh_token()`</span></span></span>
<span class="r-in"><span><span class="co"># are typically not called by users of this package directly, but are called</span></span></span>
<span class="r-in"><span><span class="co"># internally by `oauth_module_server()`. These functions are exported</span></span></span>
<span class="r-in"><span><span class="co"># nonetheless for advanced use cases. Most users will not need to</span></span></span>
<span class="r-in"><span><span class="co"># call these functions directly</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example requires a real token from a completed OAuth flow</span></span></span>
<span class="r-in"><span><span class="co"># (code is therefore not run; would error with placeholder values below)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Define client</span></span></span>
<span class="r-in"><span><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="oauth_client.html">oauth_client</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  provider <span class="op">=</span> <span class="fu"><a href="oauth_provider_github.html">oauth_provider_github</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  client_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GITHUB_OAUTH_CLIENT_ID"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  client_secret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GITHUB_OAUTH_CLIENT_SECRET"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  redirect_uri <span class="op">=</span> <span class="st">"http://127.0.0.1:8100"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Have a valid OAuthToken object; fake example below</span></span></span>
<span class="r-in"><span><span class="co"># (typically provided by `oauth_module_server()` or `handle_callback()`)</span></span></span>
<span class="r-in"><span><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="handle_callback.html">handle_callback</a></span><span class="op">(</span><span class="va">client</span>, <span class="st">"&lt;code&gt;"</span>, <span class="st">"&lt;payload&gt;"</span>, <span class="st">"&lt;browser_token&gt;"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get userinfo</span></span></span>
<span class="r-in"><span><span class="va">user_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_userinfo.html">get_userinfo</a></span><span class="op">(</span><span class="va">client</span>, <span class="va">token</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Introspect token (if supported by provider)</span></span></span>
<span class="r-in"><span><span class="va">introspection</span> <span class="op">&lt;-</span> <span class="fu"><a href="introspect_token.html">introspect_token</a></span><span class="op">(</span><span class="va">client</span>, <span class="va">token</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Refresh token</span></span></span>
<span class="r-in"><span><span class="va">new_token</span> <span class="op">&lt;-</span> <span class="fu">refresh_token</span><span class="op">(</span><span class="va">client</span>, <span class="va">token</span>, introspect <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luka Koning.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>


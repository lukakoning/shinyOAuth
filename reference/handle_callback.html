<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Handle OAuth 2.0 callback: verify state, swap code for token, verify token — handle_callback • shinyOAuth</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Handle OAuth 2.0 callback: verify state, swap code for token, verify token — handle_callback"><meta name="description" content="Handle OAuth 2.0 callback: verify state, swap code for token, verify token"><meta property="og:description" content="Handle OAuth 2.0 callback: verify state, swap code for token, verify token"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shinyOAuth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/audit-logging.html">Audit logging and hooks</a></li>
    <li><a class="dropdown-item" href="../articles/authentication-flow.html">Authentication flow</a></li>
    <li><a class="dropdown-item" href="../articles/example-spotify.html">Example: Spotify login to display listening data</a></li>
    <li><a class="dropdown-item" href="../articles/usage.html">Usage</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lukakoning/shinyOAuth/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Handle OAuth 2.0 callback: verify state, swap code for token, verify token</h1>
      <small class="dont-index">Source: <a href="https://github.com/lukakoning/shinyOAuth/blob/master/R/methods__login.R" class="external-link"><code>R/methods__login.R</code></a></small>
      <div class="d-none name"><code>handle_callback.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Handle OAuth 2.0 callback: verify state, swap code for token, verify token</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">handle_callback</span><span class="op">(</span></span>
<span>  <span class="va">oauth_client</span>,</span>
<span>  <span class="va">code</span>,</span>
<span>  <span class="va">payload</span>,</span>
<span>  <span class="va">browser_token</span>,</span>
<span>  decrypted_payload <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  state_store_values <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  shiny_session <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-oauth-client">oauth_client<a class="anchor" aria-label="anchor" href="#arg-oauth-client"></a></dt>
<dd><p>An <a href="OAuthClient.html">OAuthClient</a> object representing the OAuth client configuration.</p></dd>


<dt id="arg-code">code<a class="anchor" aria-label="anchor" href="#arg-code"></a></dt>
<dd><p>The authorization code received from the OAuth provider during the callback.</p></dd>


<dt id="arg-payload">payload<a class="anchor" aria-label="anchor" href="#arg-payload"></a></dt>
<dd><p>The encrypted state payload received from the OAuth provider during the callback
(this should be the same value that was generated and sent in <code><a href="prepare_call.html">prepare_call()</a></code>).</p></dd>


<dt id="arg-browser-token">browser_token<a class="anchor" aria-label="anchor" href="#arg-browser-token"></a></dt>
<dd><p>Browser token present in the user's session (this is managed
by <code><a href="oauth_module_server.html">oauth_module_server()</a></code> and should match the one used in <code><a href="prepare_call.html">prepare_call()</a></code>).</p></dd>


<dt id="arg-decrypted-payload">decrypted_payload<a class="anchor" aria-label="anchor" href="#arg-decrypted-payload"></a></dt>
<dd><p>Optional pre-decrypted and validated payload list
(as returned by <code>state_decrypt_gcm()</code> followed by internal validation).
Supplying this allows callers to validate and bind the state on the main
thread before dispatching to a background worker for async flows.</p></dd>


<dt id="arg-state-store-values">state_store_values<a class="anchor" aria-label="anchor" href="#arg-state-store-values"></a></dt>
<dd><p>Optional pre-fetched state store entry (a list with
<code>browser_token</code>, <code>pkce_code_verifier</code>, and <code>nonce</code>). When supplied, the
function will skip reading/removing from <code>oauth_client@state_store</code> and use
the provided values instead. This supports async flows that prefetch and
remove the single-use state entry on the main thread to avoid cross-process
cache visibility issues.</p></dd>


<dt id="arg-shiny-session">shiny_session<a class="anchor" aria-label="anchor" href="#arg-shiny-session"></a></dt>
<dd><p>Optional pre-captured Shiny session context (from
<code>capture_shiny_session_context()</code>) to include in audit events. Used when
calling from async workers that lack access to the reactive domain.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An <a href="OAuthToken.html">OAuthToken</a>` object containing the access token, refresh token,
expiration time, user information (if requested), and ID token (if applicable).
If any step of the process fails (e.g., state verification, token exchange,
token validation), an error is thrown indicating the failure reason.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Please note: `prepare_call()` &amp; `handle_callback()` are typically</span></span></span>
<span class="r-in"><span><span class="co"># not called by users of this package directly, but are called </span></span></span>
<span class="r-in"><span><span class="co"># internally by `oauth_module_server()`. These functions are exported</span></span></span>
<span class="r-in"><span><span class="co"># nonetheless for advanced use cases. Most users will not need to</span></span></span>
<span class="r-in"><span><span class="co"># call these functions directly</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Below code shows generic usage of `prepare_call()` and `handle_callback()`</span></span></span>
<span class="r-in"><span><span class="co"># (code is not run because it would require user interaction)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Define client</span></span></span>
<span class="r-in"><span><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="oauth_client.html">oauth_client</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  provider <span class="op">=</span> <span class="fu"><a href="oauth_provider_github.html">oauth_provider_github</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  client_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GITHUB_OAUTH_CLIENT_ID"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  client_secret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GITHUB_OAUTH_CLIENT_SECRET"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  redirect_uri <span class="op">=</span> <span class="st">"http://127.0.0.1:8100"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get authorization URL and and store state in client's state store</span></span></span>
<span class="r-in"><span><span class="co"># `&lt;browser_token&gt;` is a token that identifies the browser session</span></span></span>
<span class="r-in"><span><span class="co">#  and would typically be stored in a browser cookie</span></span></span>
<span class="r-in"><span><span class="co">#  (`oauth_module_server()` handles this typically)</span></span></span>
<span class="r-in"><span><span class="va">authorization_url</span> <span class="op">&lt;-</span> <span class="fu"><a href="prepare_call.html">prepare_call</a></span><span class="op">(</span><span class="va">client</span>, <span class="st">"&lt;browser_token&gt;"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Redirect user to authorization URL; retrieve code &amp; payload from query;</span></span></span>
<span class="r-in"><span><span class="co"># read also `&lt;browser_token&gt;` from browser cookie</span></span></span>
<span class="r-in"><span><span class="co"># (`oauth_module_server()` handles this typically)</span></span></span>
<span class="r-in"><span><span class="va">code</span> <span class="op">&lt;-</span> <span class="st">"..."</span></span></span>
<span class="r-in"><span><span class="va">payload</span> <span class="op">&lt;-</span> <span class="st">"..."</span></span></span>
<span class="r-in"><span><span class="va">browser_token</span> <span class="op">&lt;-</span> <span class="st">"..."</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Handle callback, exchanging code for token and validating state</span></span></span>
<span class="r-in"><span><span class="co"># (`oauth_module_server()` handles this typically)</span></span></span>
<span class="r-in"><span><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu">handle_callback</span><span class="op">(</span><span class="va">client</span>, <span class="va">code</span>, <span class="va">payload</span>, <span class="va">browser_token</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luka Koning.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

